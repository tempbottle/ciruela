
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>How Sync Works &#8212; Ciruela 0.6.8 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Storage Bookkeeping and Management" href="../database/index.html" />
    <link rel="prev" title="Websockets Protocol" href="websocket.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-sync-works">
<span id="sync-flow"></span><h1>How Sync Works<a class="headerlink" href="#how-sync-works" title="Permalink to this headline">¶</a></h1>
<p>This documents tries to describe what happens after you run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ciruela sync --append<span class="o">=</span>local-dir:/remote/dir cluster.example.org
</pre></div>
</div>
<p>This might look easy: just upload all the files to all the machines, but it’s
not so simple. Here is a non-comprehensive list of complexities:</p>
<ol class="arabic simple">
<li>We don’t want to upload to all machines, because it’s inefficient</li>
<li>But we want status of all uploads on all servers to be delivered
to the client running <code class="docutils literal notranslate"><span class="pre">sync</span></code> anyway</li>
<li>Not all directories are accepted on all nodes, we want single entrypoint
hostname for all of them anyway</li>
<li>Connections might be interrupted and some nodes are down</li>
<li>Download acks can be lost (see point above) and dir might already be there
even when starting sync</li>
<li>Nodes don’t have persistent connections between each other too,
for efficiency</li>
</ol>
<div class="section" id="indexing">
<h2>(0) Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h2>
<p>Some offline preparation is done: scan specified directory and make an “index”
of it.  Index is a file that contains list of paths and hashsums of the file
contents.</p>
</div>
<div class="section" id="direct-connections">
<h2>(1) Direct Connections<a class="headerlink" href="#direct-connections" title="Permalink to this headline">¶</a></h2>
<p>First ciruela resolves <code class="docutils literal notranslate"><span class="pre">cluster.example.org</span></code> and chooses a random sample
of up to <strong>three</strong> <a class="footnote-reference" href="#id3" id="id1">[1]</a> individual IP addresses to connect to.</p>
<p>On each direct connection client firstly sends <a class="reference internal" href="websocket.html#publishimage"><span class="std std-ref">PublishImage</span></a> then either
<a class="reference internal" href="websocket.html#appenddir"><span class="std std-ref">AppendDir</span></a> or <a class="reference internal" href="websocket.html#replacedir"><span class="std std-ref">ReplaceDir</span></a> request. Upon receiving request ciruela
(daemon) does the following things:</p>
<ol class="arabic simple">
<li>Checks if this directory is configured on this server</li>
<li>Checks whether path exists and it’s id matches request,
if both are false rejects AppendDir command</li>
<li>Checks whether signature matches any of accepted keys for that directory</li>
<li>Registers that this image should be downloaded to this path</li>
</ol>
<p>On the failure path of (1) server returns a list of hosts where to connect
to. Client establishes new connections and repeats a cycle of
<a class="reference internal" href="websocket.html#publishimage"><span class="std std-ref">PublishImage</span></a> and <a class="reference internal" href="websocket.html#appenddir"><span class="std std-ref">AppendDir</span></a> to few of the specified hosts so that
number of connections to hosts which accepted directory are three.</p>
<p>The <a class="reference internal" href="websocket.html#publishimage"><span class="std std-ref">PublishImage</span></a> call does two things:</p>
<ol class="arabic simple">
<li>Registers client as a “source” of the image, so that server knows where to
fetch this image from <a class="footnote-reference" href="#id4" id="id2">[2]</a></li>
<li>Also server marks that this client is “watching” the download progress for
this image (so that completion notifications are delivered here later)</li>
</ol>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Can be configured in <a class="reference external" href="https://docs.rs/ciruela/0.5.12/ciruela/cluster/struct.Config.html#method.initial_connections">configured</a>. In future, we might add
a command-line parameter too</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>We don’t send actual image in AppendDir/ReplaceDir call because it’s
expected that either image’s index or some blocks of the actual data can
exist on the destination host</td></tr>
</tbody>
</table>
</div>
<div class="section" id="download-process">
<h2>(2) Download Process<a class="headerlink" href="#download-process" title="Permalink to this headline">¶</a></h2>
<p>The initial <a class="reference internal" href="websocket.html#appenddir"><span class="std std-ref">AppendDir</span></a> / <a class="reference internal" href="websocket.html#replacedir"><span class="std std-ref">ReplaceDir</span></a> kicks off the whole cluster
synchronization process.</p>
<ol class="arabic simple">
<li>Right after registration initial node sends “download progress” message
to few random nodes (with 0 progress at this point) <a class="footnote-reference" href="#id8" id="id6">[3]</a></li>
<li>Then ciruela computes hash of the parent directory of the uploaded path
and sends that hash to few random nodes <a class="footnote-reference" href="#id8" id="id7">[3]</a></li>
<li>Each node (including first ones) starts the download from fetching index
(if not already cached here)</li>
<li>Then server looks in several folders in the same dir of whether there are
files which are exactly like ones being downloaded, if there are, it
hardlinks all such files in the new directory.</li>
<li>Then it starts to download blocks (the actual file data)</li>
</ol>
<p>Each index and block download works approximately by the following agorithm:</p>
<ol class="arabic simple">
<li>TBD</li>
</ol>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id6">1</a>, <a class="fn-backref" href="#id7">2</a>)</em> These two messages serve different purpose. The “download progress”
message is to find out where blocks of the image are already avaialable,
so we can fetch them from that host. And hash of the parent directory is
used to initiate downloads.</td></tr>
</tbody>
</table>
<p>(TBD)</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How Sync Works</a><ul>
<li><a class="reference internal" href="#indexing">(0) Indexing</a></li>
<li><a class="reference internal" href="#direct-connections">(1) Direct Connections</a></li>
<li><a class="reference internal" href="#download-process">(2) Download Process</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Network Protocols</a><ul>
      <li>Previous: <a href="websocket.html" title="previous chapter">Websockets Protocol</a></li>
      <li>Next: <a href="../database/index.html" title="next chapter">Storage Bookkeeping and Management</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/protocols/sync.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Paul Colomiets.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/protocols/sync.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>